<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calmify Offline PWA</title>

<!-- Inline manifest as base64 -->
<link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiQ2FsbWlmeSBPZmZsaW5lIiwic2hvcnRfbmFtZSI6IkNhbG1pZnkiLCJzdGFydF91cmwiOiIuL2luZGV4Lmh0bWwiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjYjBlMGYwIiwidGhlbWVfY29sb3IiOiIjYjBlMGYwIiwiaWNvbnMiOlt7InNyYyI6Imljb24tMTkyLnBuZyIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9wbmcifSx7InNyYyI6Imljb24tNTEyLnBuZyIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9wbmcifV19">

<meta name="theme-color" content="#b0e0f0">

<style>
:root {--bg1:#b0e0f0; --bg2:#e0f7fa; --accent:#34d399; --text:#022c3a;}
body{margin:0;font-family:'Arial',sans-serif;background:linear-gradient(to bottom,var(--bg1),var(--bg2));overflow:hidden;color:var(--text);}
.cloud{position:absolute;background:white;border-radius:50%;opacity:.7;animation:float linear infinite;}
@keyframes float{from{transform:translateX(-200px);}to{transform:translateX(120vw);}}
#app{height:100vh;display:flex;justify-content:center;align-items:center;}
.screen{background:white;width:92%;max-width:520px;height:90%;border-radius:30px;padding:24px;display:none;flex-direction:column;box-shadow:0 20px 50px rgba(0,0,0,.12);}
.screen.active{display:flex;}
h1{text-align:center;margin:8px 0 12px;}
button{background:var(--accent);color:white;border:none;padding:16px;border-radius:18px;font-size:16px;cursor:pointer;transition:transform .2s;}
button:hover{transform:scale(1.03);}
#avatar{width:140px;height:140px;margin:10px auto;background:radial-gradient(circle at top,#ffd7d7,#ffbdbd);border-radius:50%;position:relative;animation:idle 4s ease-in-out infinite;}
@keyframes idle{0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);}}
.eye{width:14px;height:14px;background:#333;border-radius:50%;position:absolute;top:50px;}
.eye.left{left:42px;} .eye.right{right:42px;}
.mouth{width:40px;height:20px;border-bottom:4px solid #333;border-radius:0 0 40px 40px;position:absolute;bottom:42px;left:50%;transform:translateX(-50%);}
.game-area{flex:1;display:flex;justify-content:center;align-items:center;text-align:center;font-size:20px;}
.reward{text-align:center;font-size:18px;color:#2e8b57;}
#settingsPanel{position:absolute;top:10px;right:10px;background:rgba(255,255,255,.9);padding:12px;border-radius:12px;z-index:5;}
label{display:block;margin:6px 0;font-size:14px;}
input[type=range]{width:100%;}
</style>
</head>
<body>

<!-- Clouds -->
<div class="cloud" style="width:160px;height:80px;top:60px;"></div>
<div class="cloud" style="width:220px;height:110px;top:220px;animation-duration:90s;"></div>
<div class="cloud" style="width:180px;height:90px;top:380px;animation-duration:80s;"></div>

<div id="app">
  <!-- START SCREEN -->
  <div class="screen active" id="start">
    <h1>Welcome to Calmify</h1>
    <div id="avatar"><div class="eye left"></div><div class="eye right"></div><div class="mouth"></div></div>
    <p style="text-align:center;">I‚Äôll stay with you and help you relax üå§Ô∏è</p>
    <button onclick="startSession()">Start Session</button>
  </div>

  <!-- GAME SCREEN -->
  <div class="screen" id="game">
    <h1 id="gameTitle"></h1>
    <div class="game-area" id="gameArea"></div>
    <button onclick="completeGame()">I‚Äôm done</button>
  </div>

  <!-- REWARD SCREEN -->
  <div class="screen" id="reward">
    <h1>Nice work ‚ú®</h1>
    <div class="reward" id="rewardText"></div>
    <button onclick="nextGame()">Next calming game</button>
  </div>
</div>

<!-- SETTINGS PANEL -->
<div id="settingsPanel">
  <label><input type="checkbox" id="toggleSound" checked> Sound</label>
  <label><input type="checkbox" id="toggleAnim" checked> Animations</label>
  <label>Speed <input type="range" id="speedRange" min="0.5" max="2" step="0.1" value="1"></label>
</div>

<script>
/* --- SETTINGS --- */
const soundToggle=document.getElementById("toggleSound");
const animToggle=document.getElementById("toggleAnim");
const speedRange=document.getElementById("speedRange");
let soundOn=true, animOn=true, speedMult=1;
soundToggle.onchange=()=>soundOn=soundToggle.checked;
animToggle.onchange=()=>animOn=animToggle.checked;
speedRange.oninput=()=>speedMult=parseFloat(speedRange.value);

/* --- SCREENS --- */
const screens={start: document.getElementById("start"),game: document.getElementById("game"),reward: document.getElementById("reward")};
const gameTitle=document.getElementById("gameTitle");
const gameArea=document.getElementById("gameArea");
const rewardText=document.getElementById("rewardText");
function show(screen){Object.values(screens).forEach(s=>s.classList.remove("active"));screens[screen].classList.add("active");}

/* --- OFFLINE AMBIENT SOUND --- */
let audioCtx, masterGain;
function startAmbient(){
  if(audioCtx)return;
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  masterGain=audioCtx.createGain(); masterGain.gain.value=0.12; masterGain.connect(audioCtx.destination);
  [60,100,150].forEach(f=>{
    const osc=audioCtx.createOscillator(); osc.type="sine"; osc.frequency.value=f;
    const gain=audioCtx.createGain(); gain.gain.value=0.04;
    osc.connect(gain); gain.connect(masterGain);
    osc.start(); osc.stop(audioCtx.currentTime+600);
  });
}

/* --- GAMES --- */
const games=[
  "Slow breathing: inhale 4s, exhale 6s",
  "Name 5 things you see around you",
  "Trace a square with finger",
  "Follow clouds with eyes",
  "Stretch your shoulders gently",
  "Blink slowly 10 times",
  "Think of a safe place",
  "Tap feet softly 30s",
  "Count backwards from 30",
  "Relax your jaw",
  "Visualize warm light around you",
  "Follow moving circle",
  "Roll your neck slowly",
  "Notice feet on the floor",
  "Name 3 calming colors",
  "Press palms together gently",
  "Read calming words slowly",
  "Notice one pleasant sound",
  "Smile slightly 20s",
  "Close eyes and breathe deeply"
];
let currentGame="", calmPoints=0;

/* --- SESSION FLOW --- */
function startSession(){startAmbient();nextGame();}
function nextGame(){
  currentGame=games[Math.floor(Math.random()*games.length)];
  gameTitle.innerText="Calming Activity";
  gameArea.innerText=currentGame;
  show("game");
}
function completeGame(){
  calmPoints+=1;
  rewardText.innerText=`You earned a calm point üíô (Total: ${calmPoints})`;
  show("reward");
}

/* --- INLINE SERVICE WORKER --- */
if('serviceWorker' in navigator){
  const swCode=`self.addEventListener('install',e=>{e.waitUntil(caches.open('calmify-v1').then(c=>c.addAll(['/'])));});
  self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));});`;
  const blob=new Blob([swCode],{type:'application/javascript'});
  navigator.serviceWorker.register(URL.createObjectURL(blob));
}
</script>
</body>
</html>
